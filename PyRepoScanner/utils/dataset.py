"""
用于下载数据集的脚本
"""
import os

import requests
from bs4 import BeautifulSoup
import PyRepoScanner.utils.basic_tools as prs_utils


# backstabbers论文提出的数据集
backstabbers = """
<ul>
  <li>10cent10</li>
  <li>10cent11</li>
  <li>11337x</li>
  <li>13377x</li>
  <li>1337c</li>
  <li>1337xx</li>
  <li>1337z</li>
  <li>2022-requests</li>
  <li>aadhaarcrypt</li>
  <li>acqusition</li>
  <li>advenced-requests</li>
  <li>ahahjesus</li>
  <li>aio5</li>
  <li>aiohttp-socks5</li>
  <li>aiohttp_proxies</li>
  <li>andex-maps</li>
  <li>android-plus-new</li>
  <li>antchain_sdk_acs_iot</li>
  <li>apidev-coop</li>
  <li>apple-py-music</li>
  <li>apple-tv-new</li>
  <li>aptx</li>
  <li>arcalife</li>
  <li>are</li>
  <li>aryi</li>
  <li>ascii2text</li>
  <li>asn2crypto</li>
  <li>aws-login0tool</li>
  <li>bahaha</li>
  <li>bcrypto</li>
  <li>beautifulsoup-new</li>
  <li>beautifulsoup4-new</li>
  <li>belarusbetter</li>
  <li>bingchilling2</li>
  <li>bitcoinliv</li>
  <li>botaa3</li>
  <li>brokescolors</li>
  <li>brokescolors2</li>
  <li>brokescolors3</li>
  <li>brokesrcl</li>
  <li>browserdiv</li>
  <li>bs4tools</li>
  <li>bullcode</li>
  <li>bzip</li>
  <li>ccsv</li>
  <li>chillie</li>
  <li>ci_common_utils</li>
  <li>ciscosparksdk</li>
  <li>cncode</li>
  <li>cncodetest</li>
  <li>cnscodes</li>
  <li>coingecko-apis</li>
  <li>coinmarketcaps</li>
  <li>colorizepip</li>
  <li>colourama</li>
  <li>colouring</li>
  <li>cookiezlog</li>
  <li>crypto-data-fetch</li>
  <li>crypto-get-price</li>
  <li>crypto-open</li>
  <li>crypto-os</li>
  <li>cryptobalance</li>
  <li>cryptographylib</li>
  <li>cryptographyy</li>
  <li>csvv</li>
  <li>ctf-q21-empire-tmp-bw31337</li>
  <li>ctf-q21-empire-tmp-ra13377</li>
  <li>ctf-q21-empire-tmp-sa13377</li>
  <li>ctf_q21_empire_tmp_1337_thc</li>
  <li>ctx</li>
  <li>daimler-mic-idca</li>
  <li>dajngo</li>
  <li>dark-magic</li>
  <li>debricked-test</li>
  <li>deeepl</li>
  <li>deep-translate</li>
  <li>deep-translation</li>
  <li>deepmountains_lrce</li>
  <li>deepmountains_rce</li>
  <li>deepmountains_wrce</li>
  <li>dependency31337</li>
  <li>diango</li>
  <li>discord.pt</li>
  <li>discord.pu</li>
  <li>discordhook</li>
  <li>discordsafety</li>
  <li>distrib</li>
  <li>disutil</li>
  <li>djago</li>
  <li>djanga</li>
  <li>django-metamaks-auth</li>
  <li>django-metamask-aut</li>
  <li>django-server</li>
  <li>django-web2-auth</li>
  <li>django-web3-aut</li>
  <li>django-web4-auth</li>
  <li>dlcsord</li>
  <li>dont-test-me</li>
  <li>dpp_client</li>
  <li>dpp_client1234</li>
  <li>drawtime</li>
  <li>easyfuncsys</li>
  <li>easyinstall</li>
  <li>eautifulsoup4</li>
  <li>eepl</li>
  <li>elenium</li>
  <li>emoji-country-flags</li>
  <li>emoki</li>
  <li>etuptool</li>
  <li>etuptools</li>
  <li>fakessh</li>
  <li>firstbasicpyapp</li>
  <li>flak7</li>
  <li>flak8</li>
  <li>flake7</li>
  <li>flask-requests-complex</li>
  <li>fpsboost</li>
  <li>free-net-vpn</li>
  <li>free-net-vpn2</li>
  <li>free-requests-module</li>
  <li>fuzywuzy</li>
  <li>fuzywuzzy</li>
  <li>fuzzywuzy</li>
  <li>fuzzzywuzzy</li>
  <li>genesisbot</li>
  <li>hameni</li>
  <li>historic-crypt</li>
  <li>hkg-sol-utils</li>
  <li>hreading</li>
  <li>htps1</li>
  <li>httiop</li>
  <li>http-interact</li>
  <li>httplat</li>
  <li>httpssp</li>
  <li>httpssus</li>
  <li>httpxgetter</li>
  <li>httpxmodifier</li>
  <li>httpxrequester</li>
  <li>httpxrequesterv2</li>
  <li>humanqueen</li>
  <li>humanqueenn</li>
  <li>igtool</li>
  <li>igtoolz</li>
  <li>important-package</li>
  <li>importantpackage</li>
  <li>instabots</li>
  <li>ipboards</li>
  <li>jango-metamask-auth</li>
  <li>jango-web3-auth</li>
  <li>jeilyfish</li>
  <li>junkeldat</li>
  <li>keybaord</li>
  <li>laysound</li>
  <li>learninglib</li>
  <li>libari</li>
  <li>libcrypt</li>
  <li>libffm</li>
  <li>libpesh</li>
  <li>libpeshka</li>
  <li>libpeshnx</li>
  <li>linkedin-scrape</li>
  <li>manganeko</li>
  <li>maratlib</li>
  <li>maratlib1</li>
  <li>matplatlib-plus</li>
  <li>memory-profile</li>
  <li>mianlmao</li>
  <li>mianooo</li>
  <li>mianshutdown</li>
  <li>miantest2</li>
  <li>mllearnlib</li>
  <li>monkeytypes</li>
  <li>mplatlib</li>
  <li>muktesitaban</li>
  <li>muktesittaban</li>
  <li>multiporn</li>
  <li>mumpy</li>
  <li>mybiubiubiu</li>
  <li>mypackage1337</li>
  <li>new-reque-20222</li>
  <li>new-request</li>
  <li>new-request-2022</li>
  <li>new-requests</li>
  <li>new-requests-2022</li>
  <li>new-requests-module</li>
  <li>nmap-python</li>
  <li>noblesse</li>
  <li>noblesse2</li>
  <li>noblessev2</li>
  <li>oklend</li>
  <li>opencb-python</li>
  <li>opencvv-python</li>
  <li>openvc</li>
  <li>osrs-hiscore</li>
  <li>owlmoon</li>
  <li>pandar</li>
  <li>pencv-python</li>
  <li>php-requests-complex</li>
  <li>pip_security</li>
  <li>piphttps</li>
  <li>pkg-with-extras</li>
  <li>pkgutil</li>
  <li>playsoun</li>
  <li>pptest</li>
  <li>private-library-dont-install</li>
  <li>promptcolor</li>
  <li>proxycrape</li>
  <li>proxyrape</li>
  <li>proxyscrope</li>
  <li>psycogp2</li>
  <li>pwd</li>
  <li>pwniepip</li>
  <li>pycbytes</li>
  <li>pyconau-funtimes</li>
  <li>pycryptdome</li>
  <li>pycryptodomes</li>
  <li>pycryptography</li>
  <li>pydobc</li>
  <li>pyg-utils</li>
  <li>pygrata</li>
  <li>pyinstaler</li>
  <li>pylibcrypt</li>
  <li>pymocks</li>
  <li>pymongosinspired13</li>
  <li>pyobfadvance</li>
  <li>pyproto2</li>
  <li>pypttt</li>
  <li>pyscrapy</li>
  <li>pyslye</li>
  <li>pytagora</li>
  <li>pytagora2</li>
  <li>pyteseract</li>
  <li>python-ftp</li>
  <li>python-kudu</li>
  <li>python-mongo</li>
  <li>python-mysql</li>
  <li>python-mysqldb</li>
  <li>python-openssl</li>
  <li>python-sqlite</li>
  <li>python3-dateutil</li>
  <li>pythonkafka</li>
  <li>pytttsx3</li>
  <li>pyvrypto</li>
  <li>pywin31</li>
  <li>pywin33</li>
  <li>pyxrypto</li>
  <li>pyymal</li>
  <li>rabin-sharmakobau</li>
  <li>readycharz</li>
  <li>redist</li>
  <li>reols</li>
  <li>req-tools</li>
  <li>reques-new-2022</li>
  <li>request</li>
  <li>requests-beta</li>
  <li>requests-new-module</li>
  <li>rgparse</li>
  <li>rq-websites</li>
  <li>rqrqrq</li>
  <li>rumihell</li>
  <li>rumihelling</li>
  <li>sagepay</li>
  <li>sandbox-sandbox.r3dcondemo.sca</li>
  <li>secrevtwo</li>
  <li>seleniun</li>
  <li>selenuim</li>
  <li>simplecalc-2022</li>
  <li>smb</li>
  <li>smplejson</li>
  <li>sonic-py-common</li>
  <li>speechrecongition</li>
  <li>statmodel</li>
  <li>statmodels</li>
  <li>statsmodel</li>
  <li>suffer</li>
  <li>teleport-client</li>
  <li>test-async</li>
  <li>threadin</li>
  <li>threeding</li>
  <li>tiktok-bots</li>
  <li>timeit</li>
  <li>torchtriton</li>
  <li>trexcolors</li>
  <li>trrfab</li>
  <li>trustpiphuh</li>
  <li>trustpiphuh1</li>
  <li>trustypip</li>
  <li>tshawn_lrce</li>
  <li>tshawn_wrce</li>
  <li>ulrlib3</li>
  <li>ultrarequests</li>
  <li>updated-requests</li>
  <li>upgrade-requests</li>
  <li>url-requests</li>
  <li>urlib3</li>
  <li>urllib</li>
  <li>uzzywuzzy</li>
  <li>very-hackerman</li>
  <li>virtualnv</li>
  <li>web-requests-autmoation</li>
  <li>web3toolz</li>
  <li>winrpcexploit</li>
  <li>xhttpsp</li>
  <li>xlibrary</li>
  <li>xss</li>
  <li>yandex-map</li>
  <li>yandex-yt</li>
  <li>yaudio</li>
  <li>yautogui</li>
  <li>ycrypto</li>
  <li>ycryptodome</li>
  <li>yessirmian</li>
  <li>yiffparty</li>
  <li>yinance</li>
  <li>yinstaller</li>
  <li>ymongo</li>
  <li>youtube-new</li>
  <li>yptt</li>
  <li>ywin32</li>
  <li>zlibsrc</li>
</ul>
"""


if __name__ == "__main__":
    soup = BeautifulSoup(backstabbers, "lxml")
    malicious_backstabbers_list = []
    for li in soup.find_all("li"):
        malicious_backstabbers_list.append(li.string)
    print(len(malicious_backstabbers_list))
    print(malicious_backstabbers_list)

    malicious_url_list = []
    for project_name in malicious_backstabbers_list:
        resp = requests.get(f"https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/{project_name}/")
        tmp_soup = BeautifulSoup(resp.text, "lxml")
        for release in tmp_soup.find_all("a"):
            file_name = release.string
            if not file_name.endswith(".tar.gz"):
                continue
            download_url = release.get("href")
            if download_url:
                real_url = f"https://mirrors.tuna.tsinghua.edu.cn/pypi/web/{download_url.lstrip('../../')}"
                malicious_url_list.append((file_name, real_url))
    print(malicious_url_list)

    for malicious_url in malicious_url_list:
        try:
            prs_utils.download_file_to_dir(malicious_url[1], "../../sample/backstabbers", malicious_url[0])
        except Exception as e:
            print(e)
